using System.Net;
using BaseFaq.Faq.Portal.Business.Faq.Commands.CreateFaqContentRef;
using BaseFaq.Faq.Portal.Business.Faq.Commands.CreateFaqTag;
using BaseFaq.Faq.Portal.Business.Faq.Queries.GetFaqContentRef;
using BaseFaq.Faq.Portal.Business.Faq.Queries.GetFaqTag;
using BaseFaq.Faq.Portal.Business.FaqItem.Commands.CreateFaqItem;
using BaseFaq.Faq.Portal.Business.FaqItem.Queries.GetFaqItem;
using BaseFaq.Faq.Portal.Business.Vote.Commands.CreateVote;
using BaseFaq.Faq.Portal.Business.Vote.Queries.GetVote;
using BaseFaq.Faq.Portal.Test.IntegrationTests.Helpers;
using Microsoft.AspNetCore.Http;
using Xunit;

namespace BaseFaq.Faq.Portal.Test.IntegrationTests.Tests.Relationships;

public class RelationshipMappingTests
{
    [Fact]
    public async Task FaqItem_Query_ReturnsContentRefRelationship()
    {
        using var context = TestContext.Create();
        var faq = await TestDataFactory.SeedFaqAsync(context.DbContext, context.SessionService.TenantId);
        var contentRef = await TestDataFactory.SeedContentRefAsync(context.DbContext, context.SessionService.TenantId);

        var createHandler = new FaqItemsCreateFaqItemCommandHandler(context.DbContext, context.SessionService);
        var createRequest = new FaqItemsCreateFaqItemCommand
        {
            Question = "Question",
            ShortAnswer = "Short",
            Sort = 1,
            VoteScore = 0,
            AiConfidenceScore = 0,
            IsActive = true,
            FaqId = faq.Id,
            ContentRefId = contentRef.Id
        };

        var id = await createHandler.Handle(createRequest, CancellationToken.None);

        var queryHandler = new FaqItemsGetFaqItemQueryHandler(context.DbContext);
        var result = await queryHandler.Handle(new FaqItemsGetFaqItemQuery { Id = id }, CancellationToken.None);

        Assert.NotNull(result);
        Assert.Equal(faq.Id, result!.FaqId);
        Assert.Equal(contentRef.Id, result.ContentRefId);
    }

    [Fact]
    public async Task FaqTag_Query_ReturnsFaqAndTagRelationship()
    {
        using var context = TestContext.Create();
        var faq = await TestDataFactory.SeedFaqAsync(context.DbContext, context.SessionService.TenantId);
        var tag = await TestDataFactory.SeedTagAsync(context.DbContext, context.SessionService.TenantId);

        var createHandler = new FaqTagsCreateFaqTagCommandHandler(context.DbContext, context.SessionService);
        var createRequest = new FaqTagsCreateFaqTagCommand { FaqId = faq.Id, TagId = tag.Id };

        var id = await createHandler.Handle(createRequest, CancellationToken.None);

        var queryHandler = new FaqTagsGetFaqTagQueryHandler(context.DbContext);
        var result = await queryHandler.Handle(new FaqTagsGetFaqTagQuery { Id = id }, CancellationToken.None);

        Assert.NotNull(result);
        Assert.Equal(faq.Id, result!.FaqId);
        Assert.Equal(tag.Id, result.TagId);
    }

    [Fact]
    public async Task FaqContentRef_Query_ReturnsFaqAndContentRefRelationship()
    {
        using var context = TestContext.Create();
        var faq = await TestDataFactory.SeedFaqAsync(context.DbContext, context.SessionService.TenantId);
        var contentRef = await TestDataFactory.SeedContentRefAsync(context.DbContext, context.SessionService.TenantId);

        var createHandler = new FaqContentRefsCreateFaqContentRefCommandHandler(
            context.DbContext,
            context.SessionService);
        var createRequest = new FaqContentRefsCreateFaqContentRefCommand
        {
            FaqId = faq.Id,
            ContentRefId = contentRef.Id
        };

        var id = await createHandler.Handle(createRequest, CancellationToken.None);

        var queryHandler = new FaqContentRefsGetFaqContentRefQueryHandler(context.DbContext);
        var result = await queryHandler.Handle(
            new FaqContentRefsGetFaqContentRefQuery { Id = id },
            CancellationToken.None);

        Assert.NotNull(result);
        Assert.Equal(faq.Id, result!.FaqId);
        Assert.Equal(contentRef.Id, result.ContentRefId);
    }

    [Fact]
    public async Task Vote_Query_ReturnsFaqItemRelationship()
    {
        var httpContext = new DefaultHttpContext();
        httpContext.Connection.RemoteIpAddress = IPAddress.Parse("203.0.113.12");
        httpContext.Request.Headers.UserAgent = "RelAgent/1.0";

        using var context = TestContext.Create(httpContext: httpContext);
        var faq = await TestDataFactory.SeedFaqAsync(context.DbContext, context.SessionService.TenantId);
        var faqItem = await TestDataFactory.SeedFaqItemAsync(
            context.DbContext,
            context.SessionService.TenantId,
            faq.Id);

        var createHandler = new VotesCreateVoteCommandHandler(
            context.DbContext,
            context.SessionService,
            context.HttpContextAccessor);
        var createRequest = new VotesCreateVoteCommand
        {
            Like = true,
            UnLikeReason = null,
            FaqItemId = faqItem.Id
        };

        var id = await createHandler.Handle(createRequest, CancellationToken.None);

        var queryHandler = new VotesGetVoteQueryHandler(context.DbContext);
        var result = await queryHandler.Handle(new VotesGetVoteQuery { Id = id }, CancellationToken.None);

        Assert.NotNull(result);
        Assert.Equal(faqItem.Id, result!.FaqItemId);
    }
}